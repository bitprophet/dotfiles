# AWS CLI v2 related things

function print-aws-creds() {
    aws configure export-credentials --format env 2>/dev/null
}

function refresh-aws-creds() {
    creds=$(print-aws-creds)
    if [[ -z "$creds" ]]; then
        # awscli is both unfriendly and lacks idempotency...
        if ! grep sso ~/.aws/config &>/dev/null; then
            aws configure sso
        fi
        aws sso login --no-browser
        creds=$(print-aws-creds)
    fi
    if [[ -z "$creds" ]]; then
        echo "SSO config and/or login went south, please fix ~/.zsh/aws!"
    else
        eval $creds
    fi
}

# For initial shell-open
if have aws; then
    refresh-aws-creds
fi
